<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
  <title>التوأم الرقمي — مدينة عَنّة الذكية</title>
  <meta name="theme-color" content="#ffffff" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand:#d79a19; --ink:#1f2937; --muted:#6b7280; }
    html,body { height:100%; margin:0; font-family:'Cairo',sans-serif; color:#111827; }
    #wrap { position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr; }
    header {
      background:#fff; border-bottom:1px solid #e5e7eb; padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#111827 }
    .brand .dot{width:28px;height:28px;border-radius:8px;background:var(--brand);display:inline-grid;place-items:center;color:#fff}
    .btn { padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn.brand { background:var(--brand); color:#fff; border-color:transparent }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    #viewer { position:relative; }
    #cesiumContainer { position:absolute; inset:0; }

    /* لوحة المعلومات */
    #panel {
      position:absolute; top:12px; right:12px; width:320px; max-width:75vw;
      background:#ffffffd8; backdrop-filter: blur(8px);
      border:1px solid #e5e7eb; border-radius:14px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
    }
    #panel h3 { margin:0 0 6px; font-size:16px }
    #panel .muted{ color:#6b7280; font-size:12px }
    #panel .row{ display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap}
    #legend{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:6px }
    .pill{ font-size:12px; padding:6px 8px; border-radius:10px; border:1px solid #e5e7eb; background:#fff }
    .attr{ font-size:12px; background:#f9fafb; border:1px solid #e5e7eb; padding:6px 8px; border-radius:10px }

    /* تلميح تحت */
    #hint {
      position:absolute; left:12px; bottom:12px; padding:8px 10px; font-size:12px;
      background:#ffffffd8; border:1px solid #e5e7eb; border-radius:10px;
    }
    @media (max-width:520px){ #panel{width:auto; left:12px; right:12px} }
  </style>

  <!-- CesiumJS (بدون مفتاح Ion) -->
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">
  <script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand"><span class="dot">ع</span> التوأم الرقمي — مدينة عَنّة</div>
    <div style="display:flex; gap:8px">
      <button id="btnHome" class="btn">إعادة تموضع</button>
      <button id="btnStyle" class="btn">تلوين حسب الاستعمال</button>
      <button id="btnReset" class="btn">إلغاء التلوين</button>
      <a href="/" class="btn brand">العودة للمنصة</a>
    </div>
  </header>

  <div id="viewer">
    <div id="cesiumContainer"></div>

    <div id="panel" dir="rtl">
      <h3>معلومات العنصر</h3>
      <div class="muted">انقر على مبنى/قطعة أرض لعرض البيانات.</div>
      <div id="attrs" class="row"></div>

      <div class="row" style="margin-top:10px">
        <div class="pill">👁 لعرض/إخفاء الطبقات انقر الأزرار أعلاه</div>
        <div class="pill">🖱 سحب: تدوير — عجلة: تكبير</div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">مفتاح الألوان (استعمالات الأرض):</div>
        <div id="legend"></div>
      </div>
    </div>

    <div id="hint">يتم تحديث هذا النموذج دوريًا من CityEngine — حدّث الصفحة بعد الدفع.</div>
  </div>
</div>

<script>
(async function(){
  // =========== الإعداد الأساسي ===========
  // استخدم OSM imagery (بدون مفاتيح) وتضاريس مسطحة لضمان عمله على استضافة ساكنة
  const viewer = new Cesium.Viewer('cesiumContainer', {
    imageryProvider: new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' }),
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),
    timeline: false, animation: false, homeButton: false, sceneModePicker: false,
    baseLayerPicker: false, geocoder: false, navigationHelpButton: false, selectionIndicator: true
  });
  viewer.scene.globe.depthTestAgainstTerrain = true;

  // =========== تحميل 3D Tiles ===========
  // ضع هنا مسار الـTileset الذي ستُصدره من CityEngine (3D Tiles):
  // مثال:  /assets/tiles/live/tileset.json
  const TILESET_URL = '/assets/tiles/live/tileset.json';

  const tileset = await Cesium.Cesium3DTileset.fromUrl(TILESET_URL, {
    // تحسين تحميل الصفائح
    dynamicScreenSpaceError: true,
    skipLevelOfDetail: true
  });
  viewer.scene.primitives.add(tileset);
  await tileset.readyPromise;

  // تقريب إلى extent المدينة
  try { viewer.zoomTo(tileset); } catch(e) {}

  // =========== تلوين حسب استعمالات الأرض ===========
  // عدّل أسماء الخصائص حسب ما تُصدّره من CityEngine (مثال: land_use, LU, useClass...)
  let currentStyled = false;
  const landUseColor = (lu) => {
    const x = (lu || '').toString().toLowerCase();
    if (x.includes('res') || x.includes('سكن')) return 'color("#f59e0b")';   // سكني
    if (x.includes('com') || x.includes('تجار')) return 'color("#10b981")'; // تجاري
    if (x.includes('ind') || x.includes('صناع')) return 'color("#6366f1")'; // صناعي
    if (x.includes('edu') || x.includes('تعلي') ) return 'color("#ef4444")'; // تعليمي
    if (x.includes('hea') || x.includes('صح')  ) return 'color("#14b8a6")'; // صحي
    if (x.includes('rec') || x.includes('ترفي') ) return 'color("#84cc16")'; // ترفيهي
    if (x.includes('gov') || x.includes('حك')  ) return 'color("#f43f5e")'; // حكومي
    return 'color("#9ca3af")'; // أخرى
  };

  function applyLandUseStyle(propName='land_use'){
    tileset.style = new Cesium.Cesium3DTileStyle({
      color: {
        conditions: [
          ['${'+propName+'} !== undefined', 'rgba(255,255,255,1)'] // placeholder
        ]
      }
    });
    // نصنع تعبير ديناميكي: نحصل على قيمة الحقل ونرجّع لونًا
    tileset.style.color = new Cesium.Expression((f)=>{
      try {
        const v = f.getProperty(propName);
        /* ترجمة land_use إلى لون */
        return eval(landUseColor(v));
      } catch(e) { return Cesium.Color.fromCssColorString('#9ca3af'); }
    });
    currentStyled = true;
  }

  function resetStyle(){
    tileset.style = undefined;
    currentStyled = false;
  }

  // =========== التفاعل: نقر لقراءة الخصائص ===========
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  const attrsBox = document.getElementById('attrs');
  function showAttrs(props){
    attrsBox.innerHTML = '';
    const keys = Object.keys(props || {}).slice(0, 16); // نكتفي بـ 16 خانة للعرض
    if (!keys.length){
      attrsBox.innerHTML = '<div class="muted">لا توجد خصائص متاحة لهذا العنصر.</div>';
      return;
    }
    keys.forEach(k=>{
      const v = props[k];
      const d = document.createElement('div');
      d.className = 'attr';
      d.textContent = k + ': ' + v;
      attrsBox.appendChild(d);
    });
  }

  handler.setInputAction((movement) => {
    const picked = viewer.scene.pick(movement.position);
    if (Cesium.defined(picked) && picked.getProperty){
      const props = {};
      // جرّب أسماء شائعة من CityEngine: name, id, land_use, height, floors...
      ['name','id','land_use','height','floors','use','lu','bldg_id','parcel','area'].forEach(p=>{
        try { const v = picked.getProperty(p); if (v !== undefined) props[p] = v; } catch(e){}
      });
      // التقط كل الحقول إن أحببت:
      try{
        const all = picked.getPropertyNames?.() || [];
        all.forEach(p=>{ if(!(p in props)) { try{ props[p] = picked.getProperty(p);}catch(e){} } });
      }catch(e){}
      showAttrs(props);
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

  // =========== مفتاح ألوان بسيط ===========
  const legend = document.getElementById('legend');
  const legendItems = [
    ['سكني','#f59e0b'],['تجاري','#10b981'],['صناعي','#6366f1'],
    ['تعليمي','#ef4444'],['صحي','#14b8a6'],['ترفيهي','#84cc16'],['حكومي','#f43f5e'],['أخرى','#9ca3af']
  ];
  legendItems.forEach(([label,color])=>{
    const d = document.createElement('div');
    d.className = 'pill'; d.style.borderColor = color+'66';
    d.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-left:6px;vertical-align:middle"></span>${label}`;
    legend.appendChild(d);
  });

  // =========== أزرار ===========
  document.getElementById('btnHome').onclick = ()=>viewer.zoomTo(tileset);
  document.getElementById('btnStyle').onclick = ()=>{
    if (!currentStyled) applyLandUseStyle('land_use'); else applyLandUseStyle('use'); // جرّب اسمًا بديلًا
  };
  document.getElementById('btnReset').onclick = resetStyle;

})();
</script>
</body>
</html>

