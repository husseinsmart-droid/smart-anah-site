<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
  <title>Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ â€” Ù…Ø¯ÙŠÙ†Ø© Ø¹ÙÙ†Ù‘Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <meta name="theme-color" content="#ffffff" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand:#d79a19; --ink:#1f2937; --muted:#6b7280; }
    html,body { height:100%; margin:0; font-family:'Cairo',sans-serif; color:#111827; }
    #wrap { position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr; }
    header {
      background:#fff; border-bottom:1px solid #e5e7eb; padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#111827 }
    .brand .dot{width:28px;height:28px;border-radius:8px;background:var(--brand);display:inline-grid;place-items:center;color:#fff}
    .btn { padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn.brand { background:var(--brand); color:#fff; border-color:transparent }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    #viewer { position:relative; }
    #cesiumContainer { position:absolute; inset:0; }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
    #panel {
      position:absolute; top:12px; right:12px; width:320px; max-width:75vw;
      background:#ffffffd8; backdrop-filter: blur(8px);
      border:1px solid #e5e7eb; border-radius:14px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
    }
    #panel h3 { margin:0 0 6px; font-size:16px }
    #panel .muted{ color:#6b7280; font-size:12px }
    #panel .row{ display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap}
    #legend{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:6px }
    .pill{ font-size:12px; padding:6px 8px; border-radius:10px; border:1px solid #e5e7eb; background:#fff }
    .attr{ font-size:12px; background:#f9fafb; border:1px solid #e5e7eb; padding:6px 8px; border-radius:10px }

    /* ØªÙ„Ù…ÙŠØ­ ØªØ­Øª */
    #hint {
      position:absolute; left:12px; bottom:12px; padding:8px 10px; font-size:12px;
      background:#ffffffd8; border:1px solid #e5e7eb; border-radius:10px;
    }
    @media (max-width:520px){ #panel{width:auto; left:12px; right:12px} }
  </style>

  <!-- CesiumJS (Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­ Ion) -->
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">
  <script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand"><span class="dot">Ø¹</span> Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ â€” Ù…Ø¯ÙŠÙ†Ø© Ø¹ÙÙ†Ù‘Ø©</div>
    <div style="display:flex; gap:8px">
      <button id="btnHome" class="btn">Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙˆØ¶Ø¹</button>
      <button id="btnStyle" class="btn">ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„</button>
      <button id="btnReset" class="btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ„ÙˆÙŠÙ†</button>
      <a href="/" class="btn brand">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©</a>
    </div>
  </header>

  <div id="viewer">
    <div id="cesiumContainer"></div>

    <div id="panel" dir="rtl">
      <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù†ØµØ±</h3>
      <div class="muted">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø¨Ù†Ù‰/Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
      <div id="attrs" class="row"></div>

      <div class="row" style="margin-top:10px">
        <div class="pill">ğŸ‘ Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù†Ù‚Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡</div>
        <div class="pill">ğŸ–± Ø³Ø­Ø¨: ØªØ¯ÙˆÙŠØ± â€” Ø¹Ø¬Ù„Ø©: ØªÙƒØ¨ÙŠØ±</div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø¶):</div>
        <div id="legend"></div>
      </div>
    </div>

    <div id="hint">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¯ÙˆØ±ÙŠÙ‹Ø§ Ù…Ù† CityEngine â€” Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹.</div>
  </div>
</div>

<script>
(async function(){
  // ======== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø±Ø¶ ========
  const viewer = new Cesium.Viewer('cesiumContainer', {
    imageryProvider: new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' }),
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),
    timeline: false, animation: false, homeButton: false, sceneModePicker: false,
    baseLayerPicker: false, geocoder: false, navigationHelpButton: false, selectionIndicator: true
  });
  viewer.scene.globe.depthTestAgainstTerrain = true;
  viewer.scene.skyBox = undefined;
  viewer.scene.skyAtmosphere = undefined;

  // ======== Ù…ÙˆØ¶Ø¹ Ø¹ÙÙ†Ù‘Ø© (Ø¹Ø¯Ù‘Ù„Ù‡ Ø¥Ø°Ø§ Ù„Ø²Ù…) ========
  const lon   = 41.9866;     // Ø®Ø· Ø§Ù„Ø·ÙˆÙ„
  const lat   = 34.3758;     // Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶
  const height= 220;         // Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ø§Ù„Ù…ØªØ± (Ø§Ø±ÙØ¹Ù‡ Ø¥Ø°Ø§ Ø§Ù„ØªØµÙ‚ Ø¨Ø§Ù„Ø£Ø±Ø¶)

  // ======== ØªØ­Ù…ÙŠÙ„ GLB (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù† ØºÙŠÙ‘Ø±Øª Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù…Ø¬Ù„Ø¯) ========
  const glbUrl = '/city3d/anahcityscenes01_0.glb?v=3';

  // Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ«Ø¨ÙŠØª Ø´Ø±Ù‚-Ø´Ù…Ø§Ù„-Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ Ø£ØµÙ„ Ø¹ÙÙ†Ù‘Ø©
  const origin = Cesium.Cartesian3.fromDegrees(lon, lat, height);
  const modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(origin);

  // Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ù‘Ø©:
  // Ø¨Ø¹Ø¶ Ù†Ù…Ø§Ø°Ø¬ CityEngine/GLB ØªØ£ØªÙŠ Ø¨Ù…Ù‚Ø§ÙŠÙŠØ³ Ø¶Ø®Ù…Ø© Ø¬Ø¯Ø§Ù‹.
  // Ù„Ù‡Ø°Ø§ Ù†Ø¨Ø¯Ø£ Ø¨Ù…Ù‚ÙŠØ§Ø³ ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø¬Ø±Ù‘Ø¨ ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± value Ø£Ø¯Ù†Ø§Ù‡ Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ.
  const MODEL_SCALE = 0.000005; // <-- ØºÙŠÙ‘Ø±Ù‡Ø§ Ø¥Ù„Ù‰ 0.000001 Ø£Ùˆ 0.00001 Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

  const model = await Cesium.Model.fromGltfAsync({
    url: glbUrl,
    modelMatrix,
    scale: MODEL_SCALE,
    // ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©:
    show: true,
    shadows: Cesium.ShadowMode.ENABLED,
    minimumPixelSize: 48
  });

  viewer.scene.primitives.add(model);
  await model.ready;

  // Ø£Ø¨Ø¹Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø¨Ø¯Ù„ zoomTo(model) Ø­ØªÙ‰ Ù„Ø§ ØªØ¯Ø®Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ø³Ù…
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(lon, lat, 3000), // Ø§Ø±ØªÙØ§Ø¹ ~ 3 ÙƒÙ…
    orientation: { heading: 0, pitch: -0.8, roll: 0 },
    duration: 1.2
  });

  // ======== ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø¶ (Ø¥Ù† ÙˆÙØ¬Ø¯Øª Ø­Ù‚ÙˆÙ„ Ù…Ù†Ø§Ø³Ø¨Ø©) ========
  let currentStyled = false;

  const landUseColor = (lu) => {
    const x = (lu || '').toString().toLowerCase();
    if (x.includes('res') || x.includes('Ø³ÙƒÙ†')) return 'color("#f59e0b")';   // Ø³ÙƒÙ†ÙŠ
    if (x.includes('com') || x.includes('ØªØ¬Ø§Ø±')) return 'color("#10b981")'; // ØªØ¬Ø§Ø±ÙŠ
    if (x.includes('ind') || x.includes('ØµÙ†Ø§Ø¹')) return 'color("#6366f1")'; // ØµÙ†Ø§Ø¹ÙŠ
    if (x.includes('edu') || x.includes('ØªØ¹Ù„ÙŠ') ) return 'color("#ef4444")'; // ØªØ¹Ù„ÙŠÙ…ÙŠ
    if (x.includes('hea') || x.includes('ØµØ­')  ) return 'color("#14b8a6")'; // ØµØ­ÙŠ
    if (x.includes('rec') || x.includes('ØªØ±ÙÙŠ') ) return 'color("#84cc16")'; // ØªØ±ÙÙŠÙ‡ÙŠ
    if (x.includes('gov') || x.includes('Ø­Ùƒ')  ) return 'color("#f43f5e")'; // Ø­ÙƒÙˆÙ…ÙŠ
    return 'color("#9ca3af")'; // Ø£Ø®Ø±Ù‰
  };

  function applyLandUseStyle(propName='land_use'){
    // Ø¥Ù† ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø®ØµØ§Ø¦Øµ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª/Ø§Ù„Ù…Ø¬Ø³Ù…
    try {
      model.style = new Cesium.Cesium3DTileStyle({
        color: 'color("#9ca3af")'
      });
    } catch (e){
      // Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ GLB Ø§Ù„ØµØ±ÙØ© Ù‚Ø¯ Ù„Ø§ ØªØ¯Ø¹Ù… TileStyleØ› ØªØ¬Ø§Ù‡Ù„ Ø¨ØµÙ…Øª.
    }
    currentStyled = true;
  }

  function resetStyle(){
    try { model.style = undefined; } catch(e){}
    currentStyled = false;
  }

  // ======== Ø§Ù„ØªÙØ§Ø¹Ù„: Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¹Ù†ØµØ± (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) ========
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  const attrsBox = document.getElementById('attrs');

  function showAttrs(obj){
    attrsBox.innerHTML = '';
    if (!obj){ attrsBox.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµØ§Ø¦Øµ Ù…ØªØ§Ø­Ø©.</div>'; return; }
    Object.entries(obj).slice(0, 16).forEach(([k,v])=>{
      const d = document.createElement('div');
      d.className = 'attr';
      d.textContent = k + ': ' + v;
      attrsBox.appendChild(d);
    });
  }

  handler.setInputAction((movement) => {
    const picked = viewer.scene.pick(movement.position);
    if (Cesium.defined(picked) && picked?.getPropertyNames){
      const props = {};
      try {
        const names = picked.getPropertyNames();
        names.forEach(n => { try{ props[n] = picked.getProperty(n); } catch(e){} });
      } catch(e){}
      showAttrs(props);
    } else {
      showAttrs(null);
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

  // ======== Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ========
  const legend = document.getElementById('legend');
  [
    ['Ø³ÙƒÙ†ÙŠ','#f59e0b'],['ØªØ¬Ø§Ø±ÙŠ','#10b981'],['ØµÙ†Ø§Ø¹ÙŠ','#6366f1'],
    ['ØªØ¹Ù„ÙŠÙ…ÙŠ','#ef4444'],['ØµØ­ÙŠ','#14b8a6'],['ØªØ±ÙÙŠÙ‡ÙŠ','#84cc16'],
    ['Ø­ÙƒÙˆÙ…ÙŠ','#f43f5e'],['Ø£Ø®Ø±Ù‰','#9ca3af']
  ].forEach(([label,color])=>{
    const d = document.createElement('div');
    d.className = 'pill'; d.style.borderColor = color+'66';
    d.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-left:6px;vertical-align:middle"></span>${label}`;
    legend.appendChild(d);
  });

  // ======== Ø£Ø²Ø±Ø§Ø± ========
  document.getElementById('btnHome').onclick = () => {
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(lon, lat, 3000),
      orientation: { heading: 0, pitch: -0.8, roll: 0 },
      duration: 1.0
    });
  };
  document.getElementById('btnStyle').onclick = ()=>{
    // Ù„Ùˆ Ø£Ø±Ø¯Øª ØªÙ„ÙˆÙŠÙ†Ù‹Ø§ Ø­Ù‚ÙŠÙ‚ÙŠÙ‹Ø§ Ø³ØªØ­ØªØ§Ø¬ 3D Tiles Ù…Ø¹ Ø®ØµØ§Ø¦ØµØ› Ù„Ù„Ù€GLB ØºØ§Ù„Ø¨Ù‹Ø§ Ù„Ù† ØªØªÙˆÙØ± Ø®ØµØ§Ø¦Øµ.
    if (!currentStyled) applyLandUseStyle('land_use'); else applyLandUseStyle('use');
  };
  document.getElementById('btnReset').onclick = resetStyle;

})();
</script>
</body>
</html>
