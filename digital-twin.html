<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
  <title>التوأم الرقمي — مدينة عَنّة الذكية (اختبار GLB)</title>
  <meta name="theme-color" content="#ffffff" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- CesiumJS -->
  <link rel="stylesheet" href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css">
  <script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>

  <style>
    :root{ --brand:#d79a19; --ink:#1f2937; --muted:#6b7280 }
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;color:#111827}
    #wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
    header{
      background:#fff;border-bottom:1px solid #e5e7eb;padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:28px;height:28px;border-radius:8px;background:var(--brand);display:inline-grid;place-items:center;color:#fff}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
    #viewer{position:relative}
    #cesiumContainer{position:absolute;inset:0}

    /* لوحة معلومات */
    #panel{
      position:absolute; top:12px; right:12px; width:320px; max-width:75vw;
      background:#ffffffd8; backdrop-filter: blur(8px);
      border:1px solid #e5e7eb; border-radius:14px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.12)
    }
    #panel h3{margin:0 0 6px; font-size:16px}
    #panel .muted{color:#6b7280; font-size:12px}
    #hint{
      position:absolute; left:12px; bottom:12px; padding:8px 10px; font-size:12px;
      background:#ffffffd8; border:1px solid #e5e7eb; border-radius:10px
    }
    @media (max-width:520px){ #panel{width:auto; left:12px; right:12px} }
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand"><span class="dot">ع</span> التوأم الرقمي — اختبار تحميل GLB</div>
    <div style="display:flex; gap:8px">
      <button id="btnHome" class="btn">إعادة تموضع</button>
      <a href="/" class="btn brand">العودة للمنصة</a>
    </div>
  </header>

  <div id="viewer">
    <div id="cesiumContainer"></div>

    <div id="panel" dir="rtl">
      <h3>ملاحظة الاختبار</h3>
      <div class="muted">
        نعرض نموذجًا قياسيًا (MilkTruck.glb) للتأكد من أن التحميل والموقع يعملان.
        إذا ظهرت الشاحنة، فالمشكلة من ملفك GLB (مقياس/محاور/مواد) وسنحوّله إلى 3D Tiles في الخطوة التالية.
      </div>
    </div>

    <div id="hint">تم وضع النموذج فوق عنّة (اختبار). استخدم العجلة للتكبير/التصغير.</div>
  </div>
</div>

<script>
(async function(){
  // 1) إنشاء العارض بموفّر خرائط بدون مفاتيح
  const viewer = new Cesium.Viewer('cesiumContainer', {
    imageryProvider: new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' }),
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),
    timeline: false, animation: false, homeButton: false, sceneModePicker: false,
    baseLayerPicker: false, geocoder: false, navigationHelpButton: false, selectionIndicator: true
  });
  // اقتراب شديد مسموح
  viewer.scene.screenSpaceCameraController.minimumZoomDistance = 0.1;
  viewer.scene.globe.depthTestAgainstTerrain = true;

  // 2) إحداثيات عنّة
  const lon = 41.9866, lat = 34.3758, height = 210;  // عدّل الارتفاع إذا احتجت
  const origin = Cesium.Cartesian3.fromDegrees(lon, lat, height);
  const enu    = Cesium.Transforms.eastNorthUpToFixedFrame(origin);

  // 3) نموذج اختبار معروف من Cesium (لا يحتاج رفع ملفاتك)
  const testUrl = 'https://cesium.com/downloads/cesiumjs/releases/1.118/Apps/SampleData/models/CesiumMilkTruck/CesiumMilkTruck.glb';

  // مقياس 1:1 في الاختبار
  const modelMatrix = Cesium.Matrix4.multiply(
    enu,
    Cesium.Matrix4.fromUniformScale(1.0),
    new Cesium.Matrix4()
  );

  let model;
  try {
    model = Cesium.Model.fromGltf({
      url: testUrl,
      modelMatrix,
      minimumPixelSize: 64,
      shadows: Cesium.ShadowMode.ENABLED,
      allowPicking: true
    });
    viewer.scene.primitives.add(model);
    await model.readyPromise;

    // 4) تحريك الكاميرا بحيث يظهر النموذج بوضوح
    const r = model.boundingSphere.radius;
    viewer.camera.flyToBoundingSphere(model.boundingSphere, {
      offset: new Cesium.HeadingPitchRange(0.0, -0.6, r * 3.0),
      duration: 0.8
    });

  } catch (e) {
    console.error('فشل تحميل نموذج الاختبار:', e);
    alert('فشل تحميل نموذج الاختبار (تحقق من الاتصال).');
    return;
  }

  // زر إعادة التموضع
  document.getElementById('btnHome').onclick = () => {
    try{
      const r = model.boundingSphere.radius;
      viewer.camera.flyToBoundingSphere(model.boundingSphere, {
        offset: new Cesium.HeadingPitchRange(0.0, -0.6, r * 3.0),
        duration: 0.6
      });
    }catch(e){}
  };
})();
</script>
</body>
</html>
