<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>منصة عَنّة الذكية — بلاغات المواطنين</title>
  <style>
    :root { --brand:#b8860b; --bg:#0b1220; --card:#121a2a; --muted:#8aa0b4; --ok:#065f46; --err:#a00; --bd:#1f2b42; }
    html,body{margin:0;padding:0;background:var(--bg);color:#e9f1f7;font-family:system-ui,Segoe UI,Roboto,Tahoma}
    .wrap{max-width:680px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;border:1px solid var(--bd);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .head{padding:16px 18px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center}
    .head h1{font-size:20px;margin:0}
    .ver{opacity:.65;font-size:12px}
    form{padding:18px}
    .label{font-size:14px;color:var(--muted);margin:16px 0 8px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn-cat{flex:1 0 30%;padding:10px;border-radius:12px;border:1px solid var(--bd);background:#0f182a;color:#e9f1f7;cursor:pointer}
    .btn-cat.active{outline:2px solid var(--brand);background:#14223b}
    input[type="file"], input[type="text"], input[type="tel"], textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid var(--bd);background:#0f182a;color:#e9f1f7;padding:12px}
    textarea{min-height:120px;resize:vertical}
    .inline{display:flex;gap:10px;align-items:center}
    .tiny{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;margin-top:16px}
    .btn{flex:1;padding:14px;border:0;border-radius:12px;cursor:pointer;font-weight:600}
    .btn-send{background:var(--brand);color:#fff}
    .btn-clear{background:#20304f;color:#e9f1f7;flex:0 0 90px}
    .alert{display:none;margin:12px 0;padding:12px;border-radius:12px;font-size:14px}
    .alert.ok{background:#e7ffe7;color:var(--ok)}
    .alert.err{background:#ffe0e0;color:var(--err)}
    .notice{padding:12px 16px;color:#d9e7ff;background:#0f182a;border-top:1px solid var(--bd)}
    /* شاشة التأكيد */
    #confirmWrap{display:none;margin:20px auto;max-width:680px}
    #confirmWrap .box{background:#0f182a;border:1px solid var(--bd);border-radius:14px;padding:18px}
    #seqImg{width:100%;border-radius:12px;border:1px solid var(--bd);background:#0b1220}
    #dlSeq,#newReportBtn{display:inline-block;text-align:center;padding:12px 16px;border-radius:10px;font-weight:600;text-decoration:none}
    #dlSeq{background:#b8860b;color:#fff;flex:1}
    #newReportBtn{background:#20304f;color:#e9f1f7;border:0;cursor:pointer;flex:0 0 160px}
    .flex{display:flex;gap:10px;margin-top:12px}
    .topbar{max-width:680px;margin:0 auto 10px;display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    .topbar a{color:#e9f1f7;text-decoration:none}
  </style>
</head>
<body>
  <div class="topbar">
    <a href="/index.html">← العودة للمنصّة</a>
    <a href="/">الصفحة الرئيسية</a>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1>بلاغات المواطنين</h1>
        <div class="ver">v1</div>
      </div>

      <div class="notice">🔔 يتم إرسال البلاغ مباشرة إلى غرفة العمليات ببلدية عَنّة عبر المنصة الذكية.</div>

      <!-- نموذج البلاغ -->
      <div id="formWrap">
        <form id="reportForm" autocomplete="off" novalidate>
          <div class="label">نوع البلاغ</div>
          <div class="row">
            <button type="button" class="btn-cat" data-cat="light">إنارة</button>
            <button type="button" class="btn-cat" data-cat="hazard">حوادث</button>
            <button type="button" class="btn-cat" data-cat="water">مياه</button>
            <button type="button" class="btn-cat" data-cat="roads">طرق</button>
            <button type="button" class="btn-cat" data-cat="waste">نفايات</button>
            <button type="button" class="btn-cat" data-cat="other">أخرى</button>
          </div>

          <div class="label">صورة الموقف (اختياري) <span class="tiny">الحد الأقصى 4MB</span></div>
          <input id="photo" type="file" accept="image/*" />

          <div class="label">الموقع</div>
          <div class="inline">
            <button type="button" id="btnGeo" class="btn btn-clear">تحديث</button>
            <input id="loc" type="text" placeholder="لم يتم تحديد الموقع" readonly />
          </div>
          <div class="tiny">يُستحسن تفعيل GPS</div>

          <div class="label">وصف البلاغ <span class="tiny">(*)</span></div>
          <textarea id="desc" placeholder="اكتب وصفًا مختصرًا" required></textarea>

          <div class="label">الاسم <span class="tiny">(*)</span></div>
          <input id="name" type="text" placeholder="الاسم الثلاثي" required />

          <div class="label">رقم الهاتف <span class="tiny">(*)</span></div>
          <input id="phone" type="tel" inputmode="numeric" placeholder="مثال: 07XXXXXXXXX" required pattern="^07\\d{9}$" title="أدخل رقمًا بصيغة 07XXXXXXXXX فقط" />
          <div class="tiny">الصيغة المقبولة: 07XXXXXXXXX</div>

          <div class="actions">
            <button type="button" class="btn btn-clear" id="btnClear">مسح</button>
            <button class="btn btn-send" id="sendBtn" type="submit">إرسال البلاغ</button>
          </div>

          <div id="alert" class="alert"></div>
        </form>
      </div>

      <!-- شاشة التأكيد -->
      <div id="confirmWrap">
        <div class="box">
          <h3 style="margin:0 0 10px">تم استلام البلاغ ✅</h3>
          <p style="margin:0 0 12px">تم تسجيل بلاغك وإرساله إلى غرفة العمليات. احتفظ بالصورة التالية التي تحتوي الرقم التسلسلي:</p>
          <img id="seqImg" alt="رقم البلاغ" />
          <div class="flex">
            <a id="dlSeq" href="#" download="ANAH-CODE.png">تحميل الصورة</a>
            <button id="newReportBtn">بلاغ جديد</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  // ===== إعداد عنوان الـ API =====
  // غيّره لو كان مختلفًا لديك.
  const API_BASE = "https://nodered.smart-anah.org";
const REPORTS_ENDPOINT = "/reports/notify";
  
  const formWrap   = document.getElementById('formWrap');
  const confirmWrap= document.getElementById('confirmWrap');
  const form       = document.getElementById('reportForm');
  const btnSend    = document.getElementById('sendBtn');
  const btnGeo     = document.getElementById('btnGeo');
  const locInput   = document.getElementById('loc');
  const photoInp   = document.getElementById('photo');
  const alertBox   = document.getElementById('alert');

const PHONE_RE = /^07\d{9}$/;  // ✅ صحيح

  function show(type,msg){
    alertBox.className = 'alert ' + (type==='err'?'err':'ok');
    alertBox.textContent = msg;
    alertBox.style.display = 'block';
  }

  // تحويل الأرقام العربية/الفارسية للاتينية + تنظيف الهاتف
  function normalizeDigits(str){
    const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    return String(str||'').replace(/[٠-٩۰-۹]/g, d=>map[d]||d);
  }
  function cleanPhone(raw){
    let s = normalizeDigits(raw);
    s = s.replace(/[^\d+]/g,'');
    if (s.startsWith('+964')) s = '0' + s.slice(4);
    else if (s.startsWith('00964')) s = '0' + s.slice(5);
    else if (s.startsWith('964')) s = '0' + s.slice(3);
    s = s.replace(/\+/g,'');
    if (s.length === 10 && s.startsWith('7')) s = '0' + s;
    s = s.replace(/\D/g,'');
    return s;
  }
  document.getElementById('phone').addEventListener('input', (e)=>{
    const pos = e.target.selectionStart;
    e.target.value = cleanPhone(e.target.value).slice(0,11);
    e.target.setSelectionRange(pos, pos);
  });

  // اختيار التصنيف
  let selectedCategory = '';
  document.querySelectorAll('.btn-cat').forEach(b=>{
    b.addEventListener('click', ()=>{
      selectedCategory = b.dataset.cat || b.textContent.trim();
      document.querySelectorAll('.btn-cat').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    });
  });

  // زر مسح
  document.getElementById('btnClear').addEventListener('click', ()=>{
    form.reset(); selectedCategory=''; alertBox.style.display='none';
    document.querySelectorAll('.btn-cat').forEach(x=>x.classList.remove('active'));
    locInput.value = '';
  });

  // الموقع
  window.__geo = {};
  if (btnGeo) {
    btnGeo.addEventListener('click', ()=>{
      if (!navigator.geolocation) { alert('المتصفح لا يدعم GPS'); return; }
      btnGeo.disabled = true;
      navigator.geolocation.getCurrentPosition(p=>{
        const lat = +p.coords.latitude.toFixed(6);
        const lon = +p.coords.longitude.toFixed(6);
        const acc = Math.round(p.coords.accuracy||0);
        window.__geo = {lat, lon};
        locInput.value = `lat ${lat}, lon ${lon} ±${acc}m`;
        btnGeo.disabled = false;
      }, _=>{
        alert('تعذّر تحديد الموقع'); btnGeo.disabled=false;
      }, {enableHighAccuracy:true, timeout:10000});
    });
  }

  async function fileToBase64(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = () => res(String(r.result));
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // رسم صورة الرقم
  function renderSeqBadge(opts){
    const {
      seqCode, name='مواطن', category='—',
      dateStr=new Date().toLocaleString('ar-IQ',{dateStyle:'medium',timeStyle:'short'}),
      city='منصة عَنّة الذكية', site='smart-anah.org'
    } = opts||{};
    const W=1024,H=512;
    const c=document.createElement('canvas'); c.width=W; c.height=H;
    const g=c.getContext('2d');

    const grd=g.createLinearGradient(0,0,W,H);
    grd.addColorStop(0,'#0b1220'); grd.addColorStop(1,'#121a2a');
    g.fillStyle=grd; g.fillRect(0,0,W,H);

    g.fillStyle='#0f182a'; roundRect(40,40,W-80,H-80,24,true);
    g.strokeStyle='#1f2b42'; g.lineWidth=2; roundRect(40,40,W-80,H-80,24,false);

    g.fillStyle='#e9f1f7'; g.font='700 44px system-ui,Segoe UI,Roboto';
    g.fillText('تأكيد استلام البلاغ',64,120);

    g.fillStyle='#8aa0b4'; g.font='24px system-ui,Segoe UI,Roboto';
    g.fillText(`${city} — ${dateStr}`,64,160);

    const y=210; const code=`رقم البلاغ: ${seqCode}`;
    g.fillStyle='#1b2742'; roundRect(64,y,Math.min(g.measureText(code).width+60,W-128),90,16,true);
    g.fillStyle='#ffd166'; g.font='700 42px ui-monospace,Consolas,monospace'; g.fillText(code,84,y+58);

    g.fillStyle='#e9f1f7'; g.font='28px system-ui,Segoe UI,Roboto';
    g.fillText(`الاسم: ${name}`,64,350); g.fillText(`الفئة: ${category}`,64,390);

    g.fillStyle='#8aa0b4'; g.font='22px system-ui,Segoe UI,Roboto'; g.fillText(site,64,H-60);

    function roundRect(x,y,w,h,r,fill=true){g.beginPath();g.moveTo(x+r,y);
      g.arcTo(x+w,y,x+w,y+h,r);g.arcTo(x+w,y+h,x,y+h,r);g.arcTo(x,y+h,x,y,r);g.arcTo(x,y,x+w,y,r);
      g.closePath(); fill?g.fill():g.stroke();
    }
    const png=c.toDataURL('image/png');
    document.getElementById('seqImg').src=png;
    const a=document.getElementById('dlSeq'); a.href=png; a.download=`${seqCode}.png`;
  }

  document.getElementById('newReportBtn').addEventListener('click', ()=>{
    confirmWrap.style.display='none';
    form.reset(); selectedCategory=''; alertBox.style.display='none';
    document.querySelectorAll('.btn-cat').forEach(x=>x.classList.remove('active'));
    locInput.value = '';
    formWrap.style.display='block';
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // الإرسال
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    alertBox.style.display='none';

    const nameVal  = document.getElementById('name').value.trim();
    const descVal  = document.getElementById('desc').value.trim();
    const phoneEl  = document.getElementById('phone');
    const phoneVal = cleanPhone(phoneEl.value);
    phoneEl.value = phoneVal;

    if (!nameVal || !descVal || !phoneVal) { show('err','يرجى ملء الاسم والوصف ورقم الهاتف.'); return; }
    if (!PHONE_RE.test(phoneVal)) { show('err','رقم الهاتف غير صحيح. الصيغة المقبولة: 07XXXXXXXXX'); return; }

    btnSend.disabled = true;

    const body = {
      category: (document.querySelector('.btn-cat.active')?.dataset.cat) || 'other',
      desc    : descVal,
      name    : nameVal,
      phone   : phoneVal,
      loc     : { lat: window.__geo?.lat || null, lon: window.__geo?.lon || null },
    };

    const f = photoInp?.files?.[0];
    if (f && f.size > 0){
      if (f.size > 4*1024*1024){ show('err','حجم الصورة يتجاوز 4MB'); btnSend.disabled=false; return; }
      const dataURL = await fileToBase64(f);
      body.photo = { base64: dataURL.split(',').pop(), type: f.type, name: f.name };
    }

    try{
      const res = await fetch(`${API_BASE}${REPORTS_ENDPOINT}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });

      let j=null, t='';
      try { j = await res.clone().json(); } catch(_){}
      try { t = await res.text(); } catch(_){}

      const seqFromJson = j?.id || j?.seq_code || j?.seq;
      const seqFromText = (t && (t.match(/ANAH-\\d{8}-\\d{4}/)||[])[0]) || null;
      const seq = seqFromJson || seqFromText;

      if (res.ok && (j?.ok===true || seq)){
        formWrap.style.display='none';
        renderSeqBadge({
          seqCode: seq || 'ANAH-????',
          name: body.name || 'مواطن',
          category: body.category || '—'
        });
        confirmWrap.style.display='block';
        window.scrollTo({top:0,behavior:'smooth'});
      } else {
        show('err','تعذّر إرسال البلاغ، حاول مرة أخرى.');
        console.warn('Notify failed',{status:res.status,json:j,text:t});
      }
    } catch(err){
      show('err','خطأ في الاتصال بالخادم.');
      console.error(err);
    } finally {
      btnSend.disabled = false;
    }
  });
})();
</script>
</body>
</html>

